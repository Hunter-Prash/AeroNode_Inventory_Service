generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model flight_seats {
  seat_id         BigInt            @id @default(autoincrement())
  flight_id       BigInt            @default(autoincrement())
  seat_number     String            @db.VarChar(5)
  cabin_class     cabin_class_type
  price           Decimal           @db.Decimal(12, 2)
  status          seat_status_type? @default(AVAILABLE)
  version         Int?              @default(1)
  flights         flights           @relation(fields: [flight_id], references: [flight_id], onDelete: Cascade, onUpdate: NoAction)
  inventory_locks inventory_locks?

  @@unique([flight_id, seat_number])
  @@index([flight_id, status], map: "idx_seats_availability")
}

model flights {
  flight_id        BigInt              @id @default(autoincrement())
  flight_code      String              @db.VarChar(15)
  origin_iata      String              @db.Char(3)
  destination_iata String              @db.Char(3)
  departure_utc    DateTime            @db.Timestamptz(6)
  arrival_utc      DateTime            @db.Timestamptz(6)
  flight_status    flight_status_type? @default(SCHEDULED)
  created_at       DateTime?           @default(now()) @db.Timestamptz(6)
  flight_seats     flight_seats[]

  @@index([origin_iata, destination_iata, departure_utc], map: "idx_flights_route")
}

model inventory_locks {
  lock_id      BigInt       @id @default(autoincrement())
  seat_id      BigInt       @unique @default(autoincrement())
  order_id     BigInt       @default(autoincrement())
  expires_at   DateTime     @db.Timestamptz(6)
  created_at   DateTime?    @default(now()) @db.Timestamptz(6)
  flight_seats flight_seats @relation(fields: [seat_id], references: [seat_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expires_at], map: "idx_locks_expiry")
}

enum cabin_class_type {
  ECONOMY
  PREMIUM_ECONOMY
  BUSINESS
  FIRST
}

enum flight_status_type {
  SCHEDULED
  DELAYED
  CANCELLED
  LANDED
}

enum seat_status_type {
  AVAILABLE
  LOCKED
  BOOKED
}
